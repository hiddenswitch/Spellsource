plugins {
  id "base"
}

apply from: "$rootDir/gradle/python.gradle"


// Top-level declarations
def venvDir = "${rootDir}/.venv"
def isWindows = System.properties['os.name'].toLowerCase().contains('windows')
def scriptsDir = isWindows ? "${venvDir}/Scripts" : "${venvDir}/bin"

def fileExt = isWindows ? ".exe" : ""
tasks.register('run') {
  group('spellsource')
  dependsOn ':venv'
  doLast {
    // Run the comfyui binary from the virtual environment
    exec {
      workingDir(layout.projectDirectory.dir("workdir"))
      commandLine([layout.projectDirectory.file("${scriptsDir}/comfyui${fileExt}").asFile.path, "--listen", "--enable-cors-header"])
    }
  }
}

tasks.register("copyShadowJar", Copy) {
  dependsOn ":spellsource-server:shadowJar"
  from tasks.getByPath(':spellsource-server:shadowJar').archiveFile
  into "src/spellsource"
}

tasks.named("build").configure {
  dependsOn "copyShadowJar"
}

